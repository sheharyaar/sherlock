# Sherlock Makefile
# Part of the Sherlock project
#
# Copyright (c) 2025-26 Mohammad Shehar Yaar Tausif
#
# This file is licensed under the MIT License.

# Generated by ChatGPT
CC := gcc
SRC := test.c

CFLAGS_COMMON := -O0
LDFLAGS_NOPIE := -no-pie
LDFLAGS_PIE   := -pie

define require-strip
	@command -v strip >/dev/null 2>&1 || { \
		echo "error: 'strip' not found. Please install binutils."; \
		exit 1; \
	}
endef

all: \
	t-nopie-plt-nocet \
	t-nopie-plt-cet \
	t-nopie-noplt \
	t-pie-plt-nocet \
	t-pie-plt-cet \
	t-pie-noplt \
	t-static \
	t-stripped-static \
	t-stripped-pie-plt-cet

# --------------------
# Non-PIE
# --------------------
t-nopie-plt-nocet:
	$(CC) $(CFLAGS_COMMON) -fno-pie -fcf-protection=none \
	      $(SRC) -o $@ $(LDFLAGS_NOPIE)

t-nopie-plt-cet:
	$(CC) $(CFLAGS_COMMON) -fno-pie -fcf-protection=full \
	      $(SRC) -o $@ $(LDFLAGS_NOPIE)

t-nopie-noplt:
	$(CC) $(CFLAGS_COMMON) -fno-pie -fno-plt \
	      $(SRC) -o $@ $(LDFLAGS_NOPIE)

# --------------------
# PIE
# --------------------
t-pie-plt-nocet:
	$(CC) $(CFLAGS_COMMON) -fPIE -fcf-protection=none \
	      $(SRC) -o $@ $(LDFLAGS_PIE)

t-pie-plt-cet:
	$(CC) $(CFLAGS_COMMON) -fPIE -fcf-protection=full \
	      $(SRC) -o $@ $(LDFLAGS_PIE)

t-pie-noplt:
	$(CC) $(CFLAGS_COMMON) -fPIE -fno-plt \
	      $(SRC) -o $@ $(LDFLAGS_PIE)

# --------------------
# Full static
# --------------------
t-static:
	$(CC) $(CFLAGS_COMMON) -static \
		$(SRC) -o $@

# --------------------
# Stripped
# --------------------

t-stripped-pie-plt-cet:
	$(call require-strip)
	$(CC) $(CFLAGS_COMMON) -fPIE -fcf-protection=full \
	      $(SRC) -o $@ $(LDFLAGS_PIE)
	strip --strip-all $@

t-stripped-static:
	$(call require-strip)
	$(CC) $(CFLAGS_COMMON) -static \
	      $(SRC) -o $@
	strip --strip-all $@

clean:
	rm -f t-*
